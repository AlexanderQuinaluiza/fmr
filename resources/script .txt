ALTER TABLE DESCUENTOS
DROP  foreign key FK_TIENE_DESCUENTO;

ALTER TABLE DESCUENTOS
DROP COLUMN ID_PRO;

create TABLE DETALLES_DESCUENTOS(
ID_PRO BIGINT(20) NOT NULL,
ID_DESC BIGINT NOT NULL,
CONSTRAINT FK_PROD_DET_DESC FOREIGN KEY (ID_PRO) REFERENCES PRODUCTOS(ID_PRO),
CONSTRAINT FK_DESC_DET_DESC FOREIGN KEY (ID_DESC) REFERENCES DESCUENTOS(ID_DESC)
) ENGINE InnoDB;


CREATE DEFINER=`root`@`localhost` PROCEDURE `pGetDescuentoByProducto`(IN `idproducto` INT)
NO SQL
begin
SELECT d.PORCENTAJE_DESC from DESCUENTOS as d,
PRODUCTOS as p ,DETALLES_DESCUENTOS as dt WHERE p.ID_PRO = dt.ID_PRO AND
p.ID_PRO = idproducto AND
CURRENT_DATE <= cast(d.FECHA_FIN_DESC as date)
AND d.ESTADO_DESC=1
and dt.ID_DESC=d.ID_DESC
limit 1;
END

/**
*trigger para insertar datos en inventario (TIPO COMPRAS)
*/
DELIMITER $$
CREATE DEFINER=`root`@`localhost` TRIGGER `registroCompraEnInventario` AFTER INSERT ON `DETALLE_COMPRAS`
FOR EACH ROW BEGIN
DECLARE FACTURA_COMPRA VARCHAR(200) DEFAULT 'sin factura';
DECLARE DESCRIPCION_COMPRA VARCHAR(140) DEFAULT '';
DECLARE FECHA_COMPRA TIMESTAMP;
DECLARE TOTAL FLOAT DEFAULT 0;
DECLARE TIPO_ITEM VARCHAR(50) DEFAULT 'compra';
DECLARE CANTIDAD_EXISTENCIA BIGINT DEFAULT 0;
DECLARE VALOR_EXISTENCIA FLOAT DEFAULT 0;
DECLARE TOTAL_EXISTENCIA FLOAT DEFAULT 0;
DECLARE CANTIDAD_ULTIMA BIGINT DEFAULT 0;
DECLARE TOTAL_ULTIMO FLOAT DEFAULT 0;
DECLARE PORCENTAJE_DESCUENTO FLOAT DEFAULT 0;
DECLARE DESCUENTO FLOAT DEFAULT 0;

DECLARE PORCENTAJE_GANANCIA FLOAT DEFAULT 0;
/*recuperar datos desde la tabla maestra COMPRAS*/
SET FACTURA_COMPRA =     (SELECT FACTURA_PROV FROM COMPRAS WHERE ID_COMP = NEW.ID_COMP LIMIT 1);
SET DESCRIPCION_COMPRA = (SELECT DESCRIPCION_COMP FROM COMPRAS WHERE ID_COMP = NEW.ID_COMP LIMIT 1);
SET FECHA_COMPRA = (SELECT FECHA_COMP FROM COMPRAS WHERE ID_COMP = NEW.ID_COMP LIMIT 1);
SET TOTAL = (NEW.CANTIDAD_PRO * NEW.PRECIO_COMP);
SET CANTIDAD_ULTIMA = (SELECT IFNULL( (SELECT CANTIDAD_EXIST FROM INVENTARIOS WHERE ID_PRO = NEW.ID_PRO ORDER BY ID DESC LIMIT 1) ,0));
SET TOTAL_ULTIMO = (SELECT IFNULL( (SELECT TOTAL_EXIST FROM INVENTARIOS WHERE ID_PRO = NEW.ID_PRO ORDER BY ID DESC LIMIT 1) ,0));
SET PORCENTAJE_GANANCIA = (SELECT GANANCIA_PRO FROM PRODUCTOS WHERE ID_PRO = NEW.ID_PRO LIMIT 1);
SET CANTIDAD_EXISTENCIA = (CANTIDAD_ULTIMA + NEW.CANTIDAD_PRO);
SET TOTAL_EXISTENCIA = (TOTAL_ULTIMO + TOTAL);
SET VALOR_EXISTENCIA = (TOTAL_EXISTENCIA / CANTIDAD_EXISTENCIA);
SET PORCENTAJE_DESCUENTO = ( SELECT fGetDescuentoByProducto(NEW.ID_PRO) );
SET PORCENTAJE_DESCUENTO = ( SELECT IFNULL(PORCENTAJE_DESCUENTO,0) );
/*SET PORCENTAJE_DESCUENTO = (SELECT IFNULL((SELECT pGetDescuentoByProducto(NEW.ID_PRO)),0))*/
SET DESCUENTO = (VALOR_EXISTENCIA/(1-PORCENTAJE_GANANCIA)*PORCENTAJE_DESCUENTO);


INSERT INTO INVENTARIOS (ID_PRO,ID_TIPO,DOC_REFERENCIA,DESCRIPCION,FECHA_COM,CANTIDAD_PRO,VALOR,TOTAL,TIPO_ITEM,CANTIDAD_EXIST,VALOR_EXIST,TOTAL_EXIST)
VALUES(NEW.ID_PRO,NEW.ID_COMP,FACTURA_COMPRA,DESCRIPCION_COMPRA,FECHA_COMPRA,NEW.CANTIDAD_PRO,NEW.PRECIO_COMP,
TOTAL, TIPO_ITEM,CANTIDAD_EXISTENCIA, VALOR_EXISTENCIA, TOTAL_EXISTENCIA);

UPDATE PRODUCTOS SET COSTO_PRO = VALOR_EXISTENCIA, PRECIO_VENTA_PRO =  (VALOR_EXISTENCIA/(1-PORCENTAJE_GANANCIA))+DESCUENTO,
STOCK_PRO = CANTIDAD_EXISTENCIA,PRECIO_PROMOCIONAL_PRO = VALOR_EXISTENCIA/(1-PORCENTAJE_GANANCIA)  WHERE ID_PRO = NEW.ID_PRO;

END$$
DELIMITER ;

/**
*trigger para insertar datos en inventario (TIPO COMPRAS)
*/
DELIMITER $$
CREATE DEFINER=`root`@`localhost` TRIGGER `registroCompraEnInventario` AFTER INSERT ON `DETALLE_COMPRAS`
FOR EACH ROW BEGIN
DECLARE FACTURA_COMPRA VARCHAR(200) DEFAULT 'sin factura';
DECLARE DESCRIPCION_COMPRA VARCHAR(140) DEFAULT '';
DECLARE FECHA_COMPRA TIMESTAMP;
DECLARE TOTAL FLOAT DEFAULT 0;
DECLARE TIPO_ITEM VARCHAR(50) DEFAULT 'compra';
DECLARE CANTIDAD_EXISTENCIA BIGINT DEFAULT 0;
DECLARE VALOR_EXISTENCIA FLOAT DEFAULT 0;
DECLARE TOTAL_EXISTENCIA FLOAT DEFAULT 0;
DECLARE CANTIDAD_ULTIMA BIGINT DEFAULT 0;
DECLARE TOTAL_ULTIMO FLOAT DEFAULT 0;
DECLARE PORCENTAJE_DESCUENTO FLOAT DEFAULT 0;
DECLARE DESCUENTO FLOAT DEFAULT 0;

DECLARE PORCENTAJE_GANANCIA FLOAT DEFAULT 0;
/*recuperar datos desde la tabla maestra COMPRAS*/
SET FACTURA_COMPRA =     (SELECT FACTURA_PROV FROM COMPRAS WHERE ID_COMP = NEW.ID_COMP LIMIT 1);
SET DESCRIPCION_COMPRA = (SELECT DESCRIPCION_COMP FROM COMPRAS WHERE ID_COMP = NEW.ID_COMP LIMIT 1);
SET FECHA_COMPRA = (SELECT FECHA_COMP FROM COMPRAS WHERE ID_COMP = NEW.ID_COMP LIMIT 1);
SET TOTAL = (NEW.CANTIDAD_PRO * NEW.PRECIO_COMP);
SET CANTIDAD_ULTIMA = (SELECT IFNULL( (SELECT CANTIDAD_EXIST FROM INVENTARIOS WHERE ID_PRO = NEW.ID_PRO ORDER BY ID DESC LIMIT 1) ,0));
SET TOTAL_ULTIMO = (SELECT IFNULL( (SELECT TOTAL_EXIST FROM INVENTARIOS WHERE ID_PRO = NEW.ID_PRO ORDER BY ID DESC LIMIT 1) ,0));
SET PORCENTAJE_GANANCIA = (SELECT GANANCIA_PRO FROM PRODUCTOS WHERE ID_PRO = NEW.ID_PRO LIMIT 1);
SET CANTIDAD_EXISTENCIA = (CANTIDAD_ULTIMA + NEW.CANTIDAD_PRO);
SET TOTAL_EXISTENCIA = (TOTAL_ULTIMO + TOTAL);
SET VALOR_EXISTENCIA = (TOTAL_EXISTENCIA / CANTIDAD_EXISTENCIA);
SET PORCENTAJE_DESCUENTO = ( SELECT fGetDescuentoByProducto(NEW.ID_PRO) );
SET PORCENTAJE_DESCUENTO = ( SELECT IFNULL(PORCENTAJE_DESCUENTO,0) );
/*SET PORCENTAJE_DESCUENTO = (SELECT IFNULL((SELECT pGetDescuentoByProducto(NEW.ID_PRO)),0))*/
SET DESCUENTO = (VALOR_EXISTENCIA/(1-PORCENTAJE_GANANCIA)*PORCENTAJE_DESCUENTO);


INSERT INTO INVENTARIOS (ID_PRO,ID_TIPO,DOC_REFERENCIA,DESCRIPCION,FECHA_COM,CANTIDAD_PRO,VALOR,TOTAL,TIPO_ITEM,CANTIDAD_EXIST,VALOR_EXIST,TOTAL_EXIST)
VALUES(NEW.ID_PRO,NEW.ID_COMP,FACTURA_COMPRA,DESCRIPCION_COMPRA,FECHA_COMPRA,NEW.CANTIDAD_PRO,NEW.PRECIO_COMP,
TOTAL, TIPO_ITEM,CANTIDAD_EXISTENCIA, VALOR_EXISTENCIA, TOTAL_EXISTENCIA);

UPDATE PRODUCTOS SET COSTO_PRO = VALOR_EXISTENCIA, PRECIO_VENTA_PRO =  (VALOR_EXISTENCIA/(1-PORCENTAJE_GANANCIA))+DESCUENTO,
STOCK_PRO = CANTIDAD_EXISTENCIA,PRECIO_PROMOCIONAL_PRO = VALOR_EXISTENCIA/(1-PORCENTAJE_GANANCIA)  WHERE ID_PRO = NEW.ID_PRO;

END$$
DELIMITER ;

/**
*trigger para insertar datos en inventario (TIPO DEVOLUCION-COMPRAS)
*/
DELIMITER $$
CREATE DEFINER=`root`@`localhost` TRIGGER `registroDevolucionCompraEnInventario` AFTER INSERT ON `DETALLE_DEVOLUCIONES`
FOR EACH ROW BEGIN
DECLARE NOTA_CREDITO VARCHAR(200) DEFAULT 'sin nota crédito';
DECLARE TIPO VARCHAR(120) DEFAULT 'Nota de crédito';
DECLARE DESCRIPCION_DEVOLUCION VARCHAR(120) DEFAULT '';
DECLARE FECHA_DEVOLUCION TIMESTAMP;
DECLARE PRECIO_COMPRA FLOAT DEFAULT 0;
DECLARE ID_COMPRA BIGINT DEFAULT 0;
DECLARE NUMERO_DOC BIGINT DEFAULT 0;
DECLARE TOTAL FLOAT DEFAULT 0;
DECLARE TIPO_ITEM VARCHAR(50) DEFAULT 'devolucion-compra';
DECLARE CANTIDAD_EXISTENCIA BIGINT DEFAULT 0;
DECLARE VALOR_EXISTENCIA FLOAT DEFAULT 0;
DECLARE TOTAL_EXISTENCIA FLOAT DEFAULT 0;
DECLARE CANTIDAD_ULTIMA BIGINT DEFAULT 0;
DECLARE TOTAL_ULTIMO FLOAT DEFAULT 0;
DECLARE PORCENTAJE_DESCUENTO FLOAT DEFAULT 0;
DECLARE DESCUENTO FLOAT DEFAULT 0;


DECLARE PORCENTAJE_GANANCIA FLOAT DEFAULT 0;
/*recuperar datos desde la tabla maestra COMPRAS*/
SET NUMERO_DOC = (SELECT NUMERO_NC FROM DEVOLUCIONES WHERE ID_DEV = NEW.ID_DEV LIMIT 1);
SET NOTA_CREDITO =     (SELECT CONCAT(TIPO," ",NUMERO_DOC));

SET DESCRIPCION_DEVOLUCION = (SELECT OBSERVACION_DEV FROM DEVOLUCIONES WHERE ID_DEV = NEW.ID_DEV LIMIT 1);
SET FECHA_DEVOLUCION = (SELECT FECHA_DEV FROM DEVOLUCIONES WHERE ID_DEV = NEW.ID_DEV LIMIT 1);
SET ID_COMPRA = (SELECT ID_COMP FROM DEVOLUCIONES WHERE ID_DEV = NEW.ID_DEV LIMIT 1);
SET PRECIO_COMPRA = (SELECT PRECIO_COMP FROM DETALLE_COMPRAS WHERE ID_COMP = ID_COMPRA AND ID_PRO = NEW.ID_PRO);

SET TOTAL = (NEW.CANTIDAD_PRO_DEV * PRECIO_COMPRA);
SET CANTIDAD_ULTIMA = (SELECT IFNULL( (SELECT CANTIDAD_EXIST FROM INVENTARIOS WHERE ID_PRO = NEW.ID_PRO ORDER BY ID DESC LIMIT 1) ,0));
SET TOTAL_ULTIMO = (SELECT IFNULL( (SELECT TOTAL_EXIST FROM INVENTARIOS WHERE ID_PRO = NEW.ID_PRO ORDER BY ID DESC LIMIT 1) ,0));
SET PORCENTAJE_GANANCIA = (SELECT GANANCIA_PRO FROM PRODUCTOS WHERE ID_PRO = NEW.ID_PRO LIMIT 1);
SET CANTIDAD_EXISTENCIA = (CANTIDAD_ULTIMA - NEW.CANTIDAD_PRO_DEV);
SET TOTAL_EXISTENCIA = (TOTAL_ULTIMO - TOTAL);
SET VALOR_EXISTENCIA = (TOTAL_EXISTENCIA / CANTIDAD_EXISTENCIA);
SET PORCENTAJE_DESCUENTO = ( SELECT fGetDescuentoByProducto(NEW.ID_PRO) );
SET PORCENTAJE_DESCUENTO = ( SELECT IFNULL(PORCENTAJE_DESCUENTO,0) );
/*SET PORCENTAJE_DESCUENTO = (SELECT IFNULL((SELECT pGetDescuentoByProducto(NEW.ID_PRO)),0))*/
SET DESCUENTO = (VALOR_EXISTENCIA/(1-PORCENTAJE_GANANCIA)*PORCENTAJE_DESCUENTO);

INSERT INTO INVENTARIOS (ID_PRO,ID_TIPO,DOC_REFERENCIA,DESCRIPCION,FECHA_COM,CANTIDAD_PRO,VALOR,TOTAL,TIPO_ITEM,CANTIDAD_EXIST,VALOR_EXIST,TOTAL_EXIST)
VALUES(NEW.ID_PRO,NEW.ID_DEV,NOTA_CREDITO,DESCRIPCION_DEVOLUCION,FECHA_DEVOLUCION,NEW.CANTIDAD_PRO_DEV,PRECIO_COMPRA,
TOTAL, TIPO_ITEM,CANTIDAD_EXISTENCIA, VALOR_EXISTENCIA, TOTAL_EXISTENCIA);

UPDATE PRODUCTOS SET COSTO_PRO = VALOR_EXISTENCIA, PRECIO_VENTA_PRO =  (VALOR_EXISTENCIA/(1-PORCENTAJE_GANANCIA))+DESCUENTO,
STOCK_PRO = CANTIDAD_EXISTENCIA,PRECIO_PROMOCIONAL_PRO = VALOR_EXISTENCIA/(1-PORCENTAJE_GANANCIA) WHERE ID_PRO = NEW.ID_PRO;

END$$
DELIMITER ;
